name: OpenWrt Official Build with Full Features

on:
  workflow_dispatch:
    inputs:
      skip_cleanup:
        description: '跳过磁盘清理（适用于调试）'
        required: false
        default: false
        type: boolean

env:
  OPENWRT_REPO: https://github.com/openwrt/openwrt.git
  OPENWRT_BRANCH: openwrt-24.10
  BUILD_TARGET: x86
  BUILD_SUBTARGET: 64
  TZ: Asia/Shanghai

jobs:
  build-openwrt:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: 1. 环境检查与准备
      run: |
        echo "当前时间: $(date)"
        echo "工作目录: $(pwd)"
        echo "可用磁盘空间:"
        df -h .
        
    - name: 2. 磁盘清理（可选）
      if: ${{ !inputs.skip_cleanup }}
      run: |
        echo "执行磁盘清理..."
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/graalvm
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        echo "清理后磁盘空间:"
        df -h .
        
    - name: 3. 安装基础编译环境
      run: |
        echo "更新APT源并安装编译依赖..."
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          time \
          xsltproc \
          zlib1g-dev \
          unzip \
          wget \
          curl
        echo "依赖安装完成"
        
    - name: 4. 安装Go语言环境
      run: |
        echo "安装Go 1.22+..."
        wget -q https://go.dev/dl/go1.22.5.linux-amd64.tar.gz
        sudo tar -C /usr/local -xzf go1.22.5.linux-amd64.tar.gz
        echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
        source ~/.bashrc
        go version
        rm go1.22.5.linux-amd64.tar.gz
        
    - name: 5. 克隆OpenWrt官方源码
      run: |
        echo "克隆OpenWrt官方仓库..."
        git clone --depth=1 $OPENWRT_REPO -b $OPENWRT_BRANCH openwrt
        cd openwrt
        echo "当前OpenWrt版本:"
        cat ./include/version.mk | grep VERSION
        
    - name: 6. 配置feeds源
      run: |
        cd openwrt
        echo "配置feeds.conf.default..."
        cat > feeds.conf.default << 'EOF'
src-git packages https://git.openwrt.org/feed/packages.git
src-git luci https://git.openwrt.org/project/luci.git
src-git routing https://git.openwrt.org/feed/routing.git
src-git telephony https://git.openwrt.org/feed/telephony.git
src-git kenzo https://github.com/kenzok8/openwrt-packages
src-git small https://github.com/kenzok8/small-package
EOF
        
        echo "更新feeds..."
        ./scripts/feeds update -a
        
        echo "安装feeds..."
        ./scripts/feeds install -a
        
    - name: 7. 创建自定义配置文件
      run: |
        cd openwrt
        
        # 基础架构配置
        echo "CONFIG_TARGET_x86=y" > .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        
        # 镜像配置
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=512" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_VDI_IMAGES=y" >> .config
        echo "CONFIG_VMDK_IMAGES=y" >> .config
        
        # 内核配置
        echo "CONFIG_KERNEL_BUILD_USER=\"OpenWrt Builder\"" >> .config
        echo "CONFIG_KERNEL_BUILD_DOMAIN=\"github.com\"" >> .config
        
        # 网卡驱动
        echo "CONFIG_PACKAGE_kmod-e1000=y" >> .config
        echo "CONFIG_PACKAGE_kmod-e1000e=y" >> .config
        echo "CONFIG_PACKAGE_kmod-igb=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ixgbe=y" >> .config
        
        # USB网卡驱动
        echo "CONFIG_PACKAGE_kmod-usb-net=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-asix=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-asix-ax88179=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-cdc-eem=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-cdc-ether=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-cdc-ncm=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-rtl8152=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-smsc95xx=y" >> .config
        
        # IPv6支持
        echo "CONFIG_PACKAGE_ipv6helper=y" >> .config
        echo "CONFIG_PACKAGE_odhcp6c=y" >> .config
        echo "CONFIG_PACKAGE_odhcpd-ipv6only=y" >> .config
        echo "CONFIG_PACKAGE_6in4=y" >> .config
        echo "CONFIG_PACKAGE_6rd=y" >> .config
        echo "CONFIG_PACKAGE_6to4=y" >> .config
        
        # 中文语言包
        echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config
        echo "CONFIG_LUCI_LANG_en=y" >> .config
        
        # Bootstrap主题
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        echo "CONFIG_LUCI_THEME_DEFAULT=\"bootstrap\"" >> .config
        
        # 基础Luci应用
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-base=y" >> .config
        echo "CONFIG_PACKAGE_luci-compat=y" >> .config
        echo "CONFIG_PACKAGE_luci-mod-admin-full=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-opkg=y" >> .config
        
        # Passwall
        echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Client=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Rust_Client=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Trojan_GO=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Brook=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_NaiveProxy=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_kcptun=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_hysteria=y" >> .config
        
        # SmartDNS
        echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
        echo "CONFIG_PACKAGE_smartdns=y" >> .config
        
        # DDNS with Cloudflare v4
        echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config
        echo "CONFIG_PACKAGE_ddns-scripts=y" >> .config
        echo "CONFIG_PACKAGE_ddns-scripts-cloudflare=y" >> .config
        echo "CONFIG_PACKAGE_ddns-scripts-services=y" >> .config
        
        # AdGuardHome (仅界面，不含内核)
        echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        echo "# CONFIG_PACKAGE_luci-app-adguardhome_INCLUDE_binary is not set" >> .config
        
        # 多拨与负载均衡
        echo "CONFIG_PACKAGE_luci-app-syncdial=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-mwan3=y" >> .config
        echo "CONFIG_PACKAGE_mwan3=y" >> .config
        
        # 网络工具
        echo "CONFIG_PACKAGE_iperf3=y" >> .config
        echo "CONFIG_PACKAGE_tcpdump=y" >> .config
        echo "CONFIG_PACKAGE_curl=y" >> .config
        echo "CONFIG_PACKAGE_wget=y" >> .config
        
        # 系统工具
        echo "CONFIG_PACKAGE_htop=y" >> .config
        echo "CONFIG_PACKAGE_nano=y" >> .config
        echo "CONFIG_PACKAGE_vim=y" >> .config
        
        # 文件系统支持
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-ntfs=y" >> .config
        
        # 生成默认配置
        make defconfig
        
        # 显示配置摘要
        echo "=== 配置摘要 ==="
        echo "目标: $BUILD_TARGET/$BUILD_SUBTARGET"
        echo "已启用的Luci应用:"
        grep "^CONFIG_PACKAGE_luci-app" .config || true
        
    - name: 8. 下载源码包
      run: |
        cd openwrt
        echo "开始下载源码包..."
        
        # 使用多线程下载
        make download -j8
        
        # 检查下载完整性
        find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true
        echo "下载完成，检查文件完整性..."
        
        # 验证哈希
        for hashfile in $(find dl -name "*.hash" -type f); do
          dir=$(dirname "$hashfile")
          cd "$dir"
          if [ -f "$(basename "$hashfile" .hash)" ]; then
            sha256sum -c "$(basename "$hashfile")" 2>/dev/null || true
          fi
          cd -
        done
        
    - name: 9. 分阶段编译
      run: |
        cd openwrt
        
        # 设置编译环境变量
        export FORCE_UNSAFE_CONFIGURE=1
        export BUILD_LOG=1
        
        echo "=== 阶段1: 编译工具链 ==="
        make toolchain/install -j$(($(nproc) + 1)) V=s 2>&1 | tee stage1_toolchain.log
        
        echo "=== 阶段2: 编译内核 ==="
        make target/compile -j$(($(nproc) + 1)) V=s 2>&1 | tee stage2_kernel.log
        
        echo "=== 阶段3: 编译软件包 ==="
        make package/compile -j$(($(nproc) + 1)) V=s 2>&1 | tee stage3_packages.log
        
        echo "=== 阶段4: 编译镜像 ==="
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee stage4_final.log || {
          echo "并行编译失败，尝试单线程编译..."
          make V=sc 2>&1 | tee stage4_final_debug.log
        }
        
        # 检查编译结果
        if [ -d "bin/targets/$BUILD_TARGET/$BUILD_SUBTARGET" ]; then
          echo "编译成功！固件位于: bin/targets/$BUILD_TARGET/$BUILD_SUBTARGET/"
          ls -la bin/targets/$BUILD_TARGET/$BUILD_SUBTARGET/
        else
          echo "编译失败，未找到输出目录"
          exit 1
        fi
        
    - name: 10. 整理输出文件
      run: |
        cd openwrt/bin/targets/$BUILD_TARGET/$BUILD_SUBTARGET
        
        # 创建版本信息
        BUILD_DATE=$(date +%Y%m%d_%H%M%S)
        echo "创建版本信息: $BUILD_DATE"
        
        # 重命名固件文件
        for file in openwrt-*-generic-*.bin openwrt-*-generic-*.img.gz openwrt-*-generic-*.vmdk openwrt-*-generic-*.vdi; do
          if [ -f "$file" ]; then
            newname="openwrt-fullfeatures-$BUILD_DATE-${file#openwrt-}"
            mv "$file" "$newname"
            echo "重命名: $file -> $newname"
          fi
        done
        
        # 生成SHA256校验文件
        sha256sum * > SHA256SUMS
        echo "SHA256SUMS内容:"
        cat SHA256SUMS
        
        # 创建README文件
        cat > README.md << 'EOF'
# OpenWrt Full Features Build

## 编译信息
- 编译时间: $BUILD_DATE
- OpenWrt版本: 24.10
- 目标平台: x86/64 generic

## 包含功能
1. IPv6完整支持
2. AdGuardHome界面（不含内核）
3. Passwall完整功能
4. SmartDNS
5. DDNS with Cloudflare v4
6. 多拨 (syncdial + mwan3)
7. Bootstrap主题 + 中文语言包
8. Intel E1000/E1000e网卡驱动
9. USB网卡驱动支持

## 固件文件说明
- generic-sysupgrade.bin: 系统升级文件
- generic-ext4-combined.img.gz: 完整镜像（gzip压缩）
- generic-ext4-combined.vdi: VirtualBox虚拟磁盘
- generic-ext4-combined.vmdk: VMware虚拟磁盘

## 登录信息
- 默认IP: 192.168.1.1
- 用户名: root
- 密码: 无（首次登录设置）

## 使用说明
1. 选择适合的镜像文件刷入设备
2. 首次启动后访问 http://192.168.1.1
3. 根据需要配置网络和插件

## 插件访问
所有已安装的插件都可以在Luci界面中找到：
- 服务 → Passwall
- 服务 → SmartDNS
- 服务 → AdGuardHome
- 服务 → 动态DNS
- 网络 → 接口 → 配置多拨
EOF
        
        # 替换日期变量
        sed -i "s/\$BUILD_DATE/$BUILD_DATE/g" README.md
        
    - name: 11. 上传编译产物
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-FullFeatures-${{ github.run_number }}
        path: |
          openwrt/bin/targets/${{ env.BUILD_TARGET }}/${{ env.BUILD_SUBTARGET }}/*
          openwrt/*.log
        retention-days: 30
        
    - name: 12. 编译状态通知
      if: always()
      run: |
        if [ -f "openwrt/bin/targets/$BUILD_TARGET/$BUILD_SUBTARGET/SHA256SUMS" ]; then
          echo "✅ 编译成功！"
          echo "固件已上传到Artifacts"
        else
          echo "❌ 编译失败"
          echo "请检查编译日志"
          exit 1
        fi

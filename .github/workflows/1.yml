name: Build OpenWrt Custom Image

on:
  workflow_dispatch:  # 手动触发
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # 每天UTC 2:00自动编译

env:
  OPENWRT_VERSION: "24.10.0"
  TARGET: "x86"
  SUBTARGET: "64"
  PROFILE: "generic"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Clean disk space
      run: |
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          subversion \
          quilt \
          libelf-dev

    - name: Clone OpenWrt source
      run: |
        git clone https://github.com/openwrt/openwrt.git --branch v${{ env.OPENWRT_VERSION }} --depth 1
        cd openwrt

    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply custom configuration
      run: |
        cd openwrt
        # 复制自定义配置
        cp ../.config .config
        # 应用配置
        make defconfig

    - name: Select packages and configuration
      run: |
        cd openwrt
        # 清理并重新配置
        make clean
        # 交互式配置（非交互式使用预设配置）
        cat << 'EOF' > .config
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y

# 基础配置
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-theme-bootstrap=y

# IPv6支持
CONFIG_PACKAGE_ipv6helper=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_odhcpd-ipv6only=y

# 网络驱动
CONFIG_PACKAGE_kmod-e1000=y
CONFIG_PACKAGE_kmod-e1000e=y
CONFIG_PACKAGE_kmod-usb-net=y
CONFIG_PACKAGE_kmod-usb-net-asix=y
CONFIG_PACKAGE_kmod-usb-net-rtl8152=y
CONFIG_PACKAGE_kmod-usb-net-cdc-eem=y
CONFIG_PACKAGE_kmod-usb-net-cdc-ether=y
CONFIG_PACKAGE_kmod-usb-net-cdc-mbim=y
CONFIG_PACKAGE_kmod-usb-net-cdc-ncm=y
CONFIG_PACKAGE_kmod-usb-net-cdc-subset=y
CONFIG_PACKAGE_kmod-usb-net-dm9601-ether=y
CONFIG_PACKAGE_kmod-usb-net-hso=y
CONFIG_PACKAGE_kmod-usb-net-huawei-cdc-ncm=y
CONFIG_PACKAGE_kmod-usb-net-ipheth=y
CONFIG_PACKAGE_kmod-usb-net-kalmia=y
CONFIG_PACKAGE_kmod-usb-net-kaweth=y
CONFIG_PACKAGE_kmod-usb-net-mcs7830=y
CONFIG_PACKAGE_kmod-usb-net-pegasus=y
CONFIG_PACKAGE_kmod-usb-net-pl=y
CONFIG_PACKAGE_kmod-usb-net-qmi-wwan=y
CONFIG_PACKAGE_kmod-usb-net-rndis=y
CONFIG_PACKAGE_kmod-usb-net-rtl8150=y
CONFIG_PACKAGE_kmod-usb-net-sierrawireless=y
CONFIG_PACKAGE_kmod-usb-net-smsc95xx=y
CONFIG_PACKAGE_kmod-usb-net-sr9700=y

# SmartDNS
CONFIG_PACKAGE_smartdns=y
CONFIG_PACKAGE_luci-app-smartdns=y

# AdGuard Home（不含内核）
CONFIG_PACKAGE_adguardhome=y
CONFIG_PACKAGE_luci-app-adguardhome=y

# Passwall
CONFIG_PACKAGE_luci-app-passwall=y
CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Client=y
CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Rust_Client=y
CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray=y
CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Trojan_Plus=y
CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Brook=y
CONFIG_PACKAGE_luci-app-passwall_INCLUDE_NaiveProxy=y
CONFIG_PACKAGE_luci-app-passwall_INCLUDE_kcptun=y
CONFIG_PACKAGE_luci-app-passwall_INCLUDE_hysteria=y
CONFIG_PACKAGE_luci-app-passwall_INCLUDE_tuic_client=y

# DDNS (Cloudflare v4)
CONFIG_PACKAGE_ddns-scripts=y
CONFIG_PACKAGE_ddns-scripts-cloudflare=y
CONFIG_PACKAGE_luci-app-ddns=y

# 其他工具
CONFIG_PACKAGE_htop=y
CONFIG_PACKAGE_nano=y
CONFIG_PACKAGE_wget-ssl=y
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_iperf3=y

# 文件系统
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-ntfs=y
CONFIG_PACKAGE_kmod-fs-vfat=y
CONFIG_PACKAGE_block-mount=y

# 中文支持
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y
CONFIG_PACKAGE_luci-i18n-ddns-zh-cn=y

# 编译设置
CONFIG_DEVEL=y
CONFIG_CCACHE=y
CONFIG_BUILD_LOG=y
EOF

        # 应用配置
        make defconfig

    - name: Download packages
      run: |
        cd openwrt
        make download -j$(nproc)
        find dl -size -1024c -exec rm -f {} \;

    - name: Build OpenWrt
      run: |
        cd openwrt
        make -j$(($(nproc) + 1)) V=s

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-images
        path: |
          openwrt/bin/targets/x86/64/*.gz
          openwrt/bin/targets/x86/64/*.img
          openwrt/bin/targets/x86/64/*.vmdk
          openwrt/bin/targets/x86/64/*.vdi
          openwrt/bin/targets/x86/64/*.qcow2
          openwrt/bin/targets/x86/64/*.elf
          openwrt/bin/targets/x86/64/sha256sums
        retention-days: 7

    - name: Create release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        files: openwrt/bin/targets/x86/64/*.gz
        tag_name: openwrt-${{ env.OPENWRT_VERSION }}-$(date +'%Y%m%d-%H%M%S')
        name: OpenWrt ${{ env.OPENWRT_VERSION }} Custom Build
        body: |
          Custom OpenWrt ${{ env.OPENWRT_VERSION }} build with:
          - IPv6 support
          - SmartDNS
          - AdGuard Home (without kernel)
          - Passwall
          - DDNS with Cloudflare v4
          - Intel E1000 and USB NIC drivers
          - LuCI with Bootstrap theme
          - Generic x86_64 image
        draft: false
        prerelease: false

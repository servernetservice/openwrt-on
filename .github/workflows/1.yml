name: ðŸ“¦ Build OpenWrt 24.10 x86_64 Full NIC

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

env:
  OPENWRT_VERSION: "openwrt-24.10"
  TARGET_ARCH: "x86_64"
  TARGET_PROFILE: "GENERIC"

jobs:
  build:
    name: âš™ï¸ Build OpenWrt with Full NIC Drivers
    runs-on: ubuntu-latest
    timeout-minutes: 480

    steps:
      - name: ðŸ§¹ Prepare Workspace
        run: |
          sudo apt update
          sudo apt install -y build-essential libncurses5-dev gawk git gettext \
            libssl-dev xsltproc unzip zlib1g-dev file rsync curl
          df -h

      - name: ðŸ“¥ Checkout OpenWrt Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ”„ Clone OpenWrt 24.10
        run: |
          rm -rf openwrt
          git clone https://github.com/openwrt/openwrt.git -b ${OPENWRT_VERSION} --depth 1 openwrt

      - name: ðŸ“¦ Update Feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ðŸ§  Apply Config (defconfig with full NIC)
        run: |
          cd openwrt
          cat > .config << 'EOF'
# Target
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_Generic=y

# Build Options
CONFIG_DEVEL=y
CONFIG_BUILD_LOG=y
CONFIG_LLVM_CLANG=y

# IPv6
CONFIG_IPV6=y
CONFIG_PACKAGE_ipv6helper=y
CONFIG_PACKAGE_ip-full=y
CONFIG_PACKAGE_ip6tables=y

# LuCI Base & Theme
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-bootstrap=y

# Multi PPPoE
CONFIG_PACKAGE_ppp=y
CONFIG_PACKAGE_ppp-mod-pppoe=y
CONFIG_PACKAGE_luci-proto-pppoe=y
CONFIG_PACKAGE_luci-syncdial=y

# DDNS Cloudflare
CONFIG_PACKAGE_luci-app-ddns=y
CONFIG_PACKAGE_ddns-scripts=y
CONFIG_PACKAGE_ddns-scripts-cloudflare=y

# AdGuardHome UI Only
CONFIG_PACKAGE_luci-app-adguardhome=y
CONFIG_ADGUARDHOME_INCLUDE_CORE=n

# SmartDNS UI Only
CONFIG_PACKAGE_luci-app-smartdns=y
CONFIG_SMARTDNS_INCLUDE_BIN=n

# Passwall UI Only
CONFIG_PACKAGE_luci-app-passwall=y
CONFIG_PASSWALL_INCLUDE_PLUGINS=n

# Small Package Repo
CONFIG_OPTS=smp

# X86-64 NIC Drivers
CONFIG_PACKAGE_kmod-e1000=y
CONFIG_PACKAGE_kmod-e1000e=y
CONFIG_PACKAGE_kmod-igb=y
CONFIG_PACKAGE_kmod-ixgbe=y
CONFIG_PACKAGE_kmod-i40e=y
CONFIG_PACKAGE_kmod-iavf=y
CONFIG_PACKAGE_kmod-bnx2=y
CONFIG_PACKAGE_kmod-bnx2x=y
CONFIG_PACKAGE_kmod-tg3=y
CONFIG_PACKAGE_kmod-8139cp=y
CONFIG_PACKAGE_kmod-8139too=y
CONFIG_PACKAGE_kmod-r8169=y
CONFIG_PACKAGE_kmod-ae=y
CONFIG_PACKAGE_kmod-fm10k=y

# USB NIC
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb-net=y
CONFIG_PACKAGE_kmod-usb-net-asix=y
CONFIG_PACKAGE_kmod-usb-net-rtl8152=y
CONFIG_PACKAGE_kmod-usb-net-rtl8150=y
CONFIG_PACKAGE_kmod-usb-net-rtl8153=y
CONFIG_PACKAGE_kmod-usb-net-rndis=y
CONFIG_PACKAGE_kmod-usb-net-cdc-ether=y
CONFIG_PACKAGE_kmod-usb-net-smsc95xx=y

# VLAN & Dummy
CONFIG_PACKAGE_kmod-8021q=y
CONFIG_PACKAGE_kmod-dummy=y

# Virtual NIC
CONFIG_PACKAGE_kmod-vmxnet3=y
CONFIG_PACKAGE_kmod-veth=y

EOF

      - name: ðŸ“Š Validate Config
        run: |
          cd openwrt
          make defconfig

      - name: ðŸ›  Start Build
        run: |
          cd openwrt
          make -j$(nproc) V=s

      - name: ðŸ“¥ Upload Firmware Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: openwrt-x86_64-full-nic
          path: |
            openwrt/bin/targets/x86/64/
            openwrt/build_dir/

      - name: ðŸ§¾ Build Summary
        run: |
          echo "âœ” Build completed"

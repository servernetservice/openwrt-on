name: OpenWrt_24.10_NoADG_Kernel

on:
  workflow_dispatch:
    inputs:
      description:
        description: '编译描述（可选）'
        required: false
        default: 'OpenWrt 24.10 x86_64 固件编译'

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: 1. 检出代码
      uses: actions/checkout@v4
      
    - name: 2. 释放磁盘空间
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        large-packages: true
        swap-storage: true
        
    - name: 3. 安装编译依赖
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          time \
          unzip \
          wget \
          xsltproc \
          zlib1g-dev
        
        # 安装 Go 语言
        sudo add-apt-repository ppa:longsleep/golang-backports -y
        sudo apt-get update -y
        sudo apt-get install -y golang-go
        
        # 设置时区
        sudo timedatectl set-timezone "$TZ"
        
    - name: 4. 克隆 OpenWrt 源码
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        
    - name: 5. 更新 feeds 和插件源
      run: |
        cd openwrt
        # 添加第三方插件源
        cat >> feeds.conf.default << 'EOF'
        src-git kenzo https://github.com/kenzok8/openwrt-packages
        src-git small https://github.com/kenzok8/small-package
        EOF
        
        # 更新 feeds
        ./scripts/feeds update -a
        
        # 移除不需要的插件
        find feeds/ -name "geoview" -type d | xargs rm -rf 2>/dev/null || true
        rm -rf feeds/luci/applications/luci-app-passwall 2>/dev/null || true
        rm -rf feeds/luci/applications/luci-app-smartdns 2>/dev/null || true
        
        # 安装 feeds
        ./scripts/feeds install -a
        
    - name: 6. 配置编译选项
      run: |
        cd openwrt
        
        # 创建基础配置
        cat > .config << 'EOF'
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y
CONFIG_TARGET_ROOTFS_EXT4FS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=512
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_LUCI_LANG_zh_Hans=y

# 主题设置
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_LUCI_THEME_DEFAULT="bootstrap"

# 网卡驱动
CONFIG_PACKAGE_kmod-e1000=y
CONFIG_PACKAGE_kmod-e1000e=y
CONFIG_PACKAGE_kmod-usb-net=y
CONFIG_PACKAGE_kmod-usb-net-asix=y
CONFIG_PACKAGE_kmod-usb-net-rtl8152=y

# 核心插件
CONFIG_PACKAGE_luci-app-passwall=y
CONFIG_PACKAGE_luci-app-smartdns=y

# AdGuardHome - 只安装界面，不包含内核
CONFIG_PACKAGE_luci-app-adguardhome=y
# CONFIG_PACKAGE_luci-app-adguardhome_INCLUDE_binary is not set

# DDNS 相关
CONFIG_PACKAGE_luci-app-ddns=y
CONFIG_PACKAGE_ddns-scripts=y
CONFIG_PACKAGE_ddns-scripts-cloudflare=y

# 多拨和负载均衡
CONFIG_PACKAGE_luci-app-syncdial=y
CONFIG_PACKAGE_luci-app-mwan3=y

# IPv6 支持
CONFIG_PACKAGE_ipv6helper=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_odhcpd-ipv6only=y

# 基础工具
CONFIG_PACKAGE_bash=y
CONFIG_PACKAGE_htop=y
CONFIG_PACKAGE_nano=y
CONFIG_PACKAGE_wget=y
CONFIG_PACKAGE_curl=y
EOF
        
        # 生成完整配置
        make defconfig
        
    - name: 7. 下载源码包
      run: |
        cd openwrt
        make download -j$(nproc) || make download -j1
        find dl -size -1024c -exec rm -f {} \;
        
    - name: 8. 编译固件
      run: |
        cd openwrt
        # 设置编译环境变量
        export FORCE_UNSAFE_CONFIGURE=1
        
        # 编译内核和工具链
        echo "开始编译..."
        make -j$(($(nproc) + 1)) || {
          echo "多线程编译失败，尝试单线程编译..."
          make -j1 V=s 2>&1 | tee build_error.log
          exit 1
        }
        
    - name: 9. 检查编译结果
      if: success()
      run: |
        cd openwrt
        echo "编译完成！"
        echo "固件位置："
        find bin/targets -name "*.img.gz" -o -name "*.img" 2>/dev/null | head -5
        
    - name: 10. 上传编译日志（失败时）
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Build_Logs_Failed
        path: |
          openwrt/build_error.log
          openwrt/.config
          
    - name: 11. 上传固件文件（成功时）
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_Firmware_x86_64
        path: openwrt/bin/targets/x86/64/*
        retention-days: 7
        
    - name: 12. 上传编译配置
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build_Configuration
        path: openwrt/.config

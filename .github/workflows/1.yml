name: OpenWrt-24.10-x86-64

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ========= 清理磁盘（防 CODE1 / CODE2） =========
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/lib/android
        sudo docker image prune -a -f
        df -h

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-distutils \
          rsync unzip zlib1g-dev file wget

    - name: Clone OpenWrt
      run: |
        git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
        cd openwrt
        ./scripts/feeds update -a

    # ========= 优先第三方源 =========
    - name: Add Third Party Feeds
      run: |
        cd openwrt
        sed -i '$a src-git passwall https://github.com/xiaorouji/openwrt-passwall' feeds.conf.default
        sed -i '$a src-git smartdns https://github.com/pymumu/openwrt-smartdns' feeds.conf.default
        sed -i '$a src-git adguard https://github.com/rufengsuixing/luci-app-adguardhome' feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # ========= 生成详细配置 =========
    - name: Generate Config
      run: |
        cd openwrt
        cat > .config << 'EOF'
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_Generic=y

        # LuCI
        CONFIG_PACKAGE_luci=y
        CONFIG_LUCI_LANG_zh_Hans=y
        CONFIG_PACKAGE_luci-theme-bootstrap=y

        # IPv6
        CONFIG_IPV6=y
        CONFIG_PACKAGE_ipv6helper=y
        CONFIG_PACKAGE_odhcp6c=y
        CONFIG_PACKAGE_odhcpd-ipv6only=y

        # 多拨（mwan3）
        CONFIG_PACKAGE_mwan3=y
        CONFIG_PACKAGE_luci-app-mwan3=y

        # DDNS Cloudflare IPv4
        CONFIG_PACKAGE_ddns-scripts=y
        CONFIG_PACKAGE_ddns-scripts-cloudflare=y
        CONFIG_PACKAGE_luci-app-ddns=y

        # SmartDNS
        CONFIG_PACKAGE_smartdns=y
        CONFIG_PACKAGE_luci-app-smartdns=y

        # PassWall
        CONFIG_PACKAGE_passwall=y
        CONFIG_PACKAGE_luci-app-passwall=y

        # AdGuardHome（不编译内核）
        CONFIG_PACKAGE_adguardhome=y
        CONFIG_PACKAGE_luci-app-adguardhome=y

        # 网卡驱动
        CONFIG_PACKAGE_kmod-e1000=y
        CONFIG_PACKAGE_kmod-usb-net=y
        CONFIG_PACKAGE_kmod-usb-net-rtl8152=y
        CONFIG_PACKAGE_kmod-usb-net-asix=y

        # 常用工具
        CONFIG_PACKAGE_curl=y
        CONFIG_PACKAGE_wget=y
        CONFIG_PACKAGE_htop=y
        CONFIG_PACKAGE_nano=y
        CONFIG_PACKAGE_bash=y

        # 不编译内核
        CONFIG_ALL_KMODS=n
        CONFIG_ALL_NONSHARED=n
        EOF

        make defconfig
        sed -n '1,200p' .config

    # ========= 下载源码 =========
    - name: Download Packages
      run: |
        cd openwrt
        make download -j$(nproc)
        find dl -size -1024c -delete

    # ========= 编译 =========
    - name: Compile OpenWrt
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    # ========= 上传全部固件 =========
    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-24.10-x86-64-Firmware
        path: openwrt/bin/targets/x86/64/


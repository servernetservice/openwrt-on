name: OpenWrt-24.10-x86_1

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set timezone
      run: sudo timedatectl set-timezone "$TZ"

    - name: Disk cleanup (Avoid CODE1 / CODE2)
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android
        sudo docker image prune -af
        sudo swapoff -a || true
        sudo fallocate -l 8G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        df -h

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
        build-essential clang flex g++ gawk gcc-multilib gettext \
        git libncurses5-dev libssl-dev python3 python3-distutils \
        rsync unzip zlib1g-dev file wget

    - name: Clone OpenWrt source
      run: |
        git clone --depth=1 -b $REPO_BRANCH $REPO_URL openwrt

    - name: Update feeds (prefer 3rd-party)
      working-directory: openwrt
      run: |
        sed -i 's|#src-git luci|src-git luci|g' feeds.conf.default

        echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall" >> feeds.conf.default
        echo "src-git smartdns https://github.com/pymumu/openwrt-smartdns" >> feeds.conf.default
        echo "src-git syncdial https://github.com/kuoruan/openwrt-syncdial" >> feeds.conf.default
        echo "src-git adguardhome https://github.com/sbwml/luci-app-adguardhome" >> feeds.conf.default

        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Generate .config
      working-directory: openwrt
      run: |
        cat > .config << 'EOF'
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_Generic=y

        CONFIG_TARGET_KERNEL_PARTSIZE=16
        CONFIG_TARGET_ROOTFS_PARTSIZE=1024

        # LuCI
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-base=y
        CONFIG_PACKAGE_luci-compat=y
        CONFIG_PACKAGE_luci-theme-bootstrap=y

        # IPv6
        CONFIG_PACKAGE_ipv6helper=y
        CONFIG_PACKAGE_kmod-ipv6=y
        CONFIG_PACKAGE_ip6tables=y
        CONFIG_PACKAGE_odhcp6c=y
        CONFIG_PACKAGE_odhcpd-ipv6only=y

        # Multi-dial & SyncDial
        CONFIG_PACKAGE_ppp=y
        CONFIG_PACKAGE_ppp-mod-pppoe=y
        CONFIG_PACKAGE_mwan3=y
        CONFIG_PACKAGE_luci-app-mwan3=y
        CONFIG_PACKAGE_syncdial=y

        # DDNS Cloudflare IPv4
        CONFIG_PACKAGE_ddns-scripts=y
        CONFIG_PACKAGE_ddns-scripts-cloudflare=y
        CONFIG_PACKAGE_luci-app-ddns=y

        # SmartDNS
        CONFIG_PACKAGE_smartdns=y
        CONFIG_PACKAGE_luci-app-smartdns=y

        # AdGuard Home (NO kernel)
        CONFIG_PACKAGE_adguardhome=y
        CONFIG_PACKAGE_luci-app-adguardhome=y

        # Passwall (NO kernel)
        CONFIG_PACKAGE_passwall=y
        CONFIG_PACKAGE_luci-app-passwall=y

        # NIC drivers
        CONFIG_PACKAGE_kmod-e1000=y
        CONFIG_PACKAGE_kmod-e1000e=y
        CONFIG_PACKAGE_kmod-usb-net=y
        CONFIG_PACKAGE_kmod-usb-net-rtl8152=y
        CONFIG_PACKAGE_kmod-usb-net-asix=y

        # Utilities
        CONFIG_PACKAGE_htop=y
        CONFIG_PACKAGE_curl=y
        CONFIG_PACKAGE_wget=y
        CONFIG_PACKAGE_unzip=y

        CONFIG_GRUB_IMAGES=y
        CONFIG_VMDK_IMAGES=y
        CONFIG_VHDX_IMAGES=y
        CONFIG_QCOW2_IMAGES=y
        EOF

        make defconfig

    - name: Download packages
      working-directory: openwrt
      run: make download -j$(nproc)

    - name: Compile firmware
      working-directory: openwrt
      run: |
        make -j$(nproc) || make -j1 V=s

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-24.10-x86_64-Generic-Final
        path: |
          openwrt/bin/targets/x86/64/*.img*
          openwrt/bin/targets/x86/64/*.gz
          openwrt/.config

name: Build OpenWrt x86_64 (24.10)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build OpenWrt 24.10 x86_64
    runs-on: ubuntu‑22.04
    timeout-minutes: 360

    steps:

    - name: 清理旧 Runner 环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev python3
    
    - name: Checkout OpenWrt
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: v24.10.0
        fetch-depth: 0

    - name: 更新 feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # -------------------------
    # 添加 third‑party small‑package 源
    - name: 添加 small‑package 源
      run: |
        # 示例添加（可按需要调整）
        cat >> feeds.conf.default <<EOF
        src‑git smallpkg https://github.com/coolsnowwolf/small‑package
        EOF
        ./scripts/feeds update smallpkg
        ./scripts/feeds install -a -p smallpkg

    - name: 清理旧配置
      run: make distclean

    - name: 自动生成默认配置
      run: |
        make x86_64_generic_defconfig

    - name: 覆盖自定义配置
      run: |
        # 使用 .config 定制内核/SOFTPACKAGES/LUCI
        cat > .config << 'EOF'
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_generic=y

        # IPv6 支持
        CONFIG_IPV6=y
        CONFIG_PACKAGE_dnsmasq_full_dhcpv6=y

        # Multi‑Dial
        CONFIG_PACKAGE_mwan3=y
        CONFIG_PACKAGE_mwan3helper=y

        # LUCI 同步拨号
        CONFIG_PACKAGE_luci‑app‑syncdial=y

        # LUCI DDNS Cloudflare‑V4
        CONFIG_PACKAGE_luci‑app‑ddns=y
        CONFIG_PACKAGE_ddns‑scripts_cloudflare_v4=y

        # Web UI
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci‑base=y
        CONFIG_PACKAGE_luci‑theme‑bootstrap=y

        # 指定需要的 LUCI 程序
        CONFIG_PACKAGE_luci‑app‑adg=y
        CONFIG_PACKAGE_luci‑app‑smartdns=y

        # Passwall 仅主程序
        CONFIG_PACKAGE_luci‑app‑passwall=y

        # Drivers: Intel & USB
        CONFIG_PACKAGE_kmod‑e1000e=y
        CONFIG_PACKAGE_kmod‑usb‑core=y
        CONFIG_PACKAGE_kmod‑usb‑net=y

        # IPv6 支持网络
        CONFIG_PACKAGE_ip6tables=y

        EOF

    - name: 自动调整配置
      run: yes "" | make oldconfig

    - name: 开始编译
      run: |
        make -j$(nproc) V=s

    - name: 打包固件日志与配置
      run: |
        mkdir -p artifacts
        cp .config artifacts/openwrt_x86_64_exported_config
        cp -r bin/targets/x86/64 artifacts/

    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: openwrt‑x86_64‑24.10
        path: artifacts/

name: Build OpenWrt Custom Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'

env:
  OPENWRT_VERSION: "24.10.0"
  TARGET: "x86"
  SUBTARGET: "64"
  PROFILE: "generic"
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 600 # 增加超时时间，x86_64 编译较慢

    steps:
    - name: 1. 检出仓库
      uses: actions/checkout@v4

    - name: 2. 释放磁盘空间
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true

    - name: 3. 安装编译环境与升级 Go
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib gettext \
        git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
        file wget subversion quilt libelf-dev
        # 必须升级 Go 才能编译最新版 Passwall
        sudo add-apt-repository ppa:longsleep/golang-backports -y
        sudo apt update
        sudo apt install golang-go -y
        sudo timedatectl set-timezone "$TZ"

    - name: 4. 克隆源码与添加插件源
      run: |
        git clone https://github.com/openwrt/openwrt.git --branch v${{ env.OPENWRT_VERSION }} --depth 1 openwrt
        cd openwrt
        # 添加第三方插件源（必须，否则找不到 Passwall 等）
        echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default
        echo "src-git small https://github.com/kenzok8/small-package" >> feeds.conf.default
        
        ./scripts/feeds update -a
        # 移除可能冲突的重复包
        find feeds/ -name "geoview" -type d | xargs rm -rf
        ./scripts/feeds install -a

    - name: 5. 生成配置文件 (.config)
      run: |
        cd openwrt
        cat << 'EOF' > .config
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_DEVICE_generic=y

        # 基础与主题
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-compat=y
        CONFIG_PACKAGE_luci-theme-bootstrap=y
        CONFIG_LUCI_THEME_DEFAULT="bootstrap"
        CONFIG_LUCI_LANG_zh_Hans=y

        # IPv6支持
        CONFIG_PACKAGE_ipv6helper=y

        # 网络驱动 (Intel + USB)
        CONFIG_PACKAGE_kmod-e1000=y
        CONFIG_PACKAGE_kmod-e1000e=y
        CONFIG_PACKAGE_kmod-usb-net=y
        CONFIG_PACKAGE_kmod-usb-net-asix=y
        CONFIG_PACKAGE_kmod-usb-net-rtl8152=y

        # 核心插件
        CONFIG_PACKAGE_luci-app-smartdns=y
        CONFIG_PACKAGE_luci-app-passwall=y
        CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray=y
        CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Rust_Client=y
        
        # AdGuard Home (排除内核)
        CONFIG_PACKAGE_luci-app-adguardhome=y
        # CONFIG_PACKAGE_luci-app-adguardhome_INCLUDE_binary is not set

        # DDNS (Cloudflare)
        CONFIG_PACKAGE_luci-app-ddns=y
        CONFIG_PACKAGE_ddns-scripts-cloudflare=y

        # 系统工具
        CONFIG_PACKAGE_htop=y
        CONFIG_PACKAGE_curl=y
        
        # 强制启用 CCACHE 提升下次编译速度
        CONFIG_CCACHE=y
        EOF
        
        make defconfig

    - name: 6. 下载包源码
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: 7. 执行编译
      run: |
        cd openwrt
        # 先尝试多线程加速，失败后单线程报错
        make -j$(nproc) || make -j1 V=s

    - name: 8. 上传固件与 Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        files: |
          openwrt/bin/targets/x86/64/*.img.gz
          openwrt/bin/targets/x86/64/*.vmdk
        tag_name: v${{ env.OPENWRT_VERSION }}-${{ github.run_id }}
        name: OpenWrt-${{ env.OPENWRT_VERSION }}-Custom
        body: |
          Build date: $(date +'%Y-%m-%d %H:%M:%S')
          Theme: Bootstrap (Default)
          Includes: Passwall, SmartDNS, AdGuardHome (No Kernel)

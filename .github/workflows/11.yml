name: OpenWrt_x86_64_Official_Custom

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: 1. 检出与空间清理
      uses: actions/checkout@v4

    - name: 2. 清理磁盘空间与环境安装
      run: |
        sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d/* /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://is.gd/depends_ubuntu_2204)
        sudo apt-get remove -y golang-go
        
        # 安装官方 Go 1.25 (解决 Code 2 关键)
        wget -q https://go.dev/dl/go1.25.0.linux-amd64.tar.gz
        sudo tar -C /usr/local -xzf go1.25.0.linux-amd64.tar.gz
        rm go1.25.0.linux-amd64.tar.gz
        
        echo "/usr/local/go/bin" >> $GITHUB_PATH
        sudo ln -sf /usr/local/go/bin/go /usr/bin/go
        sudo timedatectl set-timezone "$TZ"

    - name: 3. 更新插件源与去重
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default
        echo "src-git small https://github.com/kenzok8/small-package" >> feeds.conf.default
        
        ./scripts/feeds update -a
        rm -rf feeds/luci/applications/luci-app-passwall
        rm -rf feeds/luci/applications/luci-app-smartdns
        rm -rf feeds/packages/lang/golang
        ./scripts/feeds install -a -f

    - name: 4. 固件定制配置 (修复 L48 语法)
      run: |
        cd openwrt
        cat > .config <<EOF
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_DEVICE_generic=y
        CONFIG_LUCI_LANG_zh_Hans=y
        CONFIG_PACKAGE_luci-theme-bootstrap=y
        CONFIG_LUCI_THEME_DEFAULT="bootstrap"
        CONFIG_PACKAGE_kmod-e1000=y
        CONFIG_PACKAGE_kmod-e1000e=y
        CONFIG_PACKAGE_kmod-usb-net=y
        CONFIG_PACKAGE_kmod-usb-net-asix=y
        CONFIG_PACKAGE_kmod-usb-net-rtl8152=y
        CONFIG_PACKAGE_luci-app-syncdial=y
        CONFIG_PACKAGE_luci-app-mwan3=y
        CONFIG_PACKAGE_luci-app-ddns=y
        CONFIG_PACKAGE_ddns-scripts-cloudflare=y
        CONFIG_PACKAGE_ipv6helper=y
        CONFIG_PACKAGE_luci-app-passwall=y
        CONFIG_PACKAGE_luci-app-smartdns=y
        CONFIG_PACKAGE_luci-app-adguardhome=y
        # CONFIG_PACKAGE_luci-app-adguardhome_INCLUDE_binary is not set
        CONFIG_PACKAGE_luci-app-ttyd=y
        EOF
        
        # 强制将所有软件从模块(m)改为内置(y)
        sed -i 's/=m/=y/g' .config
        make defconfig

    - name: 5. 源码下载与编译
      id: compile
      run: |
        cd openwrt
        make download -j8
        export PATH="/usr/local/go/bin:$PATH"
        make -j$(nproc) || make -j1 V=s 2>&1 | tee build.log
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=fail" >> $GITHUB_OUTPUT
        fi
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: 6. 整理全量固件与软件
      if: always()
      run: |
        mkdir -p FIRMWARE_ALL
        if [ -d "openwrt/bin/targets/x86/64/" ]; then
          find openwrt/bin/targets/x86/64/ -type f \( -name "*.img*" -o -name "*.manifest" \) -exec cp -f {} FIRMWARE_ALL/ \;
        fi
        if [ -d "openwrt/bin/packages/x86_64/" ]; then
          mkdir -p FIRMWARE_ALL/packages
          find openwrt/bin/packages/x86_64/ -type f -name "*.ipk" -exec cp -f {} FIRMWARE_ALL/packages/ \;
        fi
        [ -f openwrt/build.log ] && cp -f openwrt/build.log FIRMWARE_ALL/ || true
        [ -f openwrt/.config ] && cp -f openwrt/.config FIRMWARE_ALL/full_config.config || true
        
        if [ -z "$(ls -A FIRMWARE_ALL 2>/dev/null)" ]; then
          echo "Build failed" > FIRMWARE_ALL/ERROR.txt
        fi

    - name: 7. 上传所有产出固件
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_x86_64_Full_Pack_${{ env.FILE_DATE }}
        path: FIRMWARE_ALL/

# .github/workflows/openwrt-build.yml
name: OpenWrt x86-64 Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrt Version'
        required: true
        default: '22.03.5'
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 0'

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: 清理磁盘空间
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        sudo apt autoremove -y
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h
        
    - name: 检查可用空间
      run: |
        df -h
        if [ $(df --output=avail / | tail -1) -lt 25000000 ]; then
          echo "错误：磁盘空间不足，至少需要25GB"
          exit 1
        fi
        
    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          python3-pip \
          rsync \
          subversion \
          swig \
          time \
          xsltproc \
          zlib1g-dev \
          wget \
          unzip \
          jq
        
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: true
        
    - name: 配置 feeds
      run: |
        # 备份原始 feeds.conf.default
        cp feeds.conf.default feeds.conf.default.bak
        
        # 创建新的 feeds 配置
        cat > feeds.conf.default << 'EOF'
src-git packages https://git.openwrt.org/feed/packages.git;openwrt-22.03
src-git luci https://git.openwrt.org/project/luci.git;openwrt-22.03
src-git routing https://git.openwrt.org/feed/routing.git;openwrt-22.03
src-git telephony https://git.openwrt.org/feed/telephony.git;openwrt-22.03
src-git kenzok8 https://github.com/kenzok8/small-package
src-git small https://github.com/kenzok8/small
EOF
        
        # 更新 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: 应用配置
      run: |
        # 创建 .config 文件
        cat > .config << 'EOF'
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_Generic=y
CONFIG_TARGET_ROOTFS_EXT4FS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=512
CONFIG_TARGET_IMAGES_GZIP=y

# 内核配置
CONFIG_LINUX_5_15=y
CONFIG_KERNEL_BUILD_USER="OpenWrt"
CONFIG_KERNEL_BUILD_DOMAIN="github.com"

# 基础包
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_fdisk=y
CONFIG_PACKAGE_libfdisk=y
CONFIG_PACKAGE_bash=y
CONFIG_PACKAGE_nano=y
CONFIG_PACKAGE_wget-ssl=y
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_openssl-util=y

# 网络驱动
CONFIG_PACKAGE_kmod-e1000=y
CONFIG_PACKAGE_kmod-e1000e=y
CONFIG_PACKAGE_kmod-usb-net=y
CONFIG_PACKAGE_kmod-usb-net-asix=y
CONFIG_PACKAGE_kmod-usb-net-rtl8152=y
CONFIG_PACKAGE_kmod-usb-net-cdc-eem=y
CONFIG_PACKAGE_kmod-usb-net-cdc-ether=y
CONFIG_PACKAGE_kmod-usb-net-cdc-mbim=y
CONFIG_PACKAGE_kmod-usb-net-cdc-ncm=y
CONFIG_PACKAGE_kmod-usb-net-cdc-subset=y
CONFIG_PACKAGE_kmod-usb-net-dm9601-ether=y
CONFIG_PACKAGE_kmod-usb-net-hso=y
CONFIG_PACKAGE_kmod-usb-net-huawei-cdc-ncm=y
CONFIG_PACKAGE_kmod-usb-net-ipheth=y
CONFIG_PACKAGE_kmod-usb-net-kalmia=y
CONFIG_PACKAGE_kmod-usb-net-kaweth=y
CONFIG_PACKAGE_kmod-usb-net-mcs7830=y
CONFIG_PACKAGE_kmod-usb-net-pegasus=y
CONFIG_PACKAGE_kmod-usb-net-qmi-wwan=y
CONFIG_PACKAGE_kmod-usb-net-rndis=y
CONFIG_PACKAGE_kmod-usb-net-rtl8150=y
CONFIG_PACKAGE_kmod-usb-net-sierrawireless=y
CONFIG_PACKAGE_kmod-usb-net-smsc95xx=y
CONFIG_PACKAGE_kmod-usb-net-sr9700=y

# IPv6支持
CONFIG_PACKAGE_ipv6helper=y
CONFIG_PACKAGE_dnsmasq_full_dhcpv6=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_odhcpd-ipv6only=y

# LUCI界面
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-lib-base=y
CONFIG_PACKAGE_luci-lib-ip=y
CONFIG_PACKAGE_luci-lib-jsonc=y
CONFIG_PACKAGE_luci-lib-nixio=y
CONFIG_LUCI_LANG_zh_Hans=y

# Bootstrap主题
CONFIG_PACKAGE_luci-theme-bootstrap=y

# 多拨
CONFIG_PACKAGE_luci-proto-mbond=y
CONFIG_PACKAGE_luci-app-syncdial=y
CONFIG_PACKAGE_syncdial=y

# DDNS (Cloudflare v4)
CONFIG_PACKAGE_ddns-scripts-cloudflare=y
CONFIG_PACKAGE_luci-app-ddns=y

# AdGuardHome (仅界面)
CONFIG_PACKAGE_luci-app-adguardhome=y

# SmartDNS
CONFIG_PACKAGE_luci-app-smartdns=y
CONFIG_PACKAGE_smartdns=y

# PassWall (仅界面)
CONFIG_PACKAGE_luci-app-passwall=y

# 编译优化
CONFIG_CCACHE=y
CONFIG_BUILD_LOG=y
EOF
        
        # 备份配置
        cp .config .config.bak
        
        # 生成完整配置
        make defconfig
        
        # 检查配置差异
        if ! diff .config .config.bak > /dev/null; then
          echo "配置有变化，重新应用..."
          cp .config.bak .config
          make defconfig
        fi
        
    - name: 下载依赖
      run: |
        echo "开始下载依赖包..."
        make download -j$(nproc) || make download -j1 V=s
        
        # 检查下载完整性
        find dl -size -1024c -exec ls -la {} \;
        find dl -size -1024c -exec rm -f {} \;
        
    - name: 编译固件
      run: |
        # 设置编译环境
        export FORCE_UNSAFE_CONFIGURE=1
        
        # 显示编译信息
        echo "CPU核心数: $(nproc)"
        echo "可用内存: $(free -h | awk '/^Mem:/ {print $2}')"
        
        # 开始编译（分阶段编译避免内存不足）
        echo "阶段1: 编译工具链..."
        make tools/compile -j$(nproc) V=s
        
        echo "阶段2: 编译工具..."
        make toolchain/compile -j$(nproc) V=s
        
        echo "阶段3: 编译目标..."
        make target/compile -j$(nproc) V=s
        
        echo "阶段4: 编译软件包..."
        make package/compile -j$(nproc) V=s
        
        echo "阶段5: 生成镜像..."
        make target/install -j$(nproc) V=s
        
        # 检查编译结果
        if [ -f "bin/targets/x86/64/openwrt-22.03.5-x86-64-generic-ext4-combined.img.gz" ]; then
          echo "编译成功！"
          ls -la bin/targets/x86/64/
        else
          echo "编译失败，检查错误日志"
          tail -200 build.log 2>/dev/null || echo "没有找到build.log"
          exit 1
        fi
        
    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-x86-64-firmware
        path: |
          bin/targets/x86/64/*
        if-no-files-found: error
        retention-days: 30
        
    - name: 上传编译日志
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs
        path: |
          build.log
          logs/
        if-no-files-found: ignore
        retention-days: 7
        
    - name: 上传配置文件
      uses: actions/upload-artifact@v4
      with:
        name: config-files
        path: |
          .config
          .config.bak
          feeds.conf.default
          feeds.conf.default.bak
        if-no-files-found: error
        retention-days: 30
        
    - name: 生成编译报告
      if: always()
      run: |
        echo "=== 编译报告 ==="
        echo "编译时间: $(date)"
        echo "工作流: ${{ github.workflow }}"
        echo "运行ID: ${{ github.run_id }}"
        
        if [ -f "bin/targets/x86/64/.files" ]; then
          echo "生成的文件:"
          cat bin/targets/x86/64/.files
        fi
        
        echo "磁盘使用情况:"
        df -h
        
        echo "编译目录大小:"
        du -sh . || true

# .github/workflows/openwrt-build.yml
name: OpenWrt x86-64 Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrt Version'
        required: true
        default: '22.03.5'
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 0'

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: 清理磁盘空间
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        df -h
        
    - name: 检查可用空间
      run: |
        df -h
        if [ $(df --output=avail / | tail -1) -lt 20000000 ]; then
          echo "磁盘空间不足，至少需要20GB"
          exit 1
        fi
        
    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          time \
          xsltproc \
          zlib1g-dev \
          wget \
          unzip
        
    - name: 检出代码
      uses: actions/checkout@v3
      with:
        submodules: true
        
    - name: 配置 feeds
      run: |
        # 添加第三方源
        echo "src-git kenzok8 https://github.com/kenzok8/small-package" >> feeds.conf.default
        echo "src-git small https://github.com/kenzok8/small" >> feeds.conf.default
        
        # 更新 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: 应用配置
      run: |
        # 复制配置文件
        cp .config .config.bak
        
        # 生成完整配置
        make defconfig
        
        # 清理旧配置
        make clean
        rm -rf ./tmp
        rm -rf .config
        cp .config.bak .config
        
        # 最终配置检查
        make defconfig
        
    - name: 下载依赖
      run: |
        make download -j$(nproc)
        find dl -size -1024c -exec rm -f {} \;
        
    - name: 编译固件
      run: |
        # 设置编译环境
        export FORCE_UNSAFE_CONFIGURE=1
        
        # 开始编译
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log
        
        # 检查编译结果
        if [ $? -ne 0 ]; then
          echo "编译失败，检查错误日志"
          tail -100 build.log
          exit 1
        fi
        
    - name: 上传固件
      uses: actions/upload-artifact@v3
      with:
        name: openwrt-x86-64-firmware
        path: |
          bin/targets/x86/64/*
          build.log
        retention-days: 7
        
    - name: 上传配置
      uses: actions/upload-artifact@v3
      with:
        name: openwrt-config
        path: |
          .config
          .config.bak
          feeds.conf.default
        retention-days: 7

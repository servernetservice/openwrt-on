name: OpenWrt_24.10_NoADG_Kernel

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: 1. 检出与清理空间
      uses: actions/checkout@v4

    - name: 释放磁盘空间
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true

    - name: 2. 安装环境与 Go 升级
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://is.gd/depends_ubuntu_2204)
        sudo add-apt-repository ppa:longsleep/golang-backports -y
        sudo apt update
        sudo apt install golang-go -y
        sudo timedatectl set-timezone "$TZ"

    - name: 3. 更新插件源与去重
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default
        echo "src-git small https://github.com/kenzok8/small-package" >> feeds.conf.default
        
        ./scripts/feeds update -a
        # 删除冲突包，优先使用第三方源
        find feeds/ -name "geoview" -type d | xargs rm -rf
        rm -rf feeds/luci/applications/luci-app-passwall
        rm -rf feeds/luci/applications/luci-app-smartdns
        rm -rf feeds/packages/net/adguardhome
        
        ./scripts/feeds install -a

    - name: 4. 固件定制配置
      run: |
        cd openwrt
        # 基础架构设置
        echo "CONFIG_TARGET_x86=y" >> .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        
        # 语言与主题 (Bootstrap)
        echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        echo "CONFIG_LUCI_THEME_DEFAULT=\"bootstrap\"" >> .config
        
        # 核心插件
        echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
        
        # 【关键】AdGuardHome 只装界面，不含内核 (强制设为 n)
        echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-adguardhome_INCLUDE_binary=n" >> .config
        
        # 网卡驱动与常用工具
        echo "CONFIG_PACKAGE_kmod-e1000=y" >> .config
        echo "CONFIG_PACKAGE_kmod-e1000e=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-asix=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-net-rtl8152=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config
        echo "CONFIG_PACKAGE_ddns-scripts-cloudflare=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-syncdial=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-mwan3=y" >> .config
        echo "CONFIG_PACKAGE_ipv6helper=y" >> .config
        
        # 补充：确保磁盘分区足够大 (针对 X86)
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=64" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=512" >> .config
        
        make defconfig

    - name: 5. 源码预下载
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: 6. 执行编译
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        # 第一次尝试多线程编译
        make -j$(nproc) || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: 7. 整理固件文件
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/x86/64
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: 8. 上传日志与固件
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_Build_Results
        path: |
          ${{ env.FIRMWARE }}/*
          openwrt/.config
          openwrt/build.log

name: OpenWrt_24.10_Full_Firmware_Upload

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: 1. 检出与清理空间
      uses: actions/checkout@v4

    - name: 释放磁盘空间
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true

    - name: 2. 安装环境与升级 Go 1.25+
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://is.gd/depends_ubuntu_2204)
        sudo apt-get remove -y golang-go
        # 安装最新版 Go 以满足 v2ray-plugin 等插件需求
        curl -L https://git.io/vXGSu | bash -s -- --version 1.25.0
        echo "PATH=$PATH:/usr/local/go/bin" >> $GITHUB_PATH
        sudo ln -sf /usr/local/go/bin/go /usr/bin/go
        sudo timedatectl set-timezone "$TZ"

    - name: 3. 更新插件源与去重
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default
        echo "src-git small https://github.com/kenzok8/small-package" >> feeds.conf.default
        
        ./scripts/feeds update -a
        find feeds/ -name "geoview" -type d | xargs rm -rf
        rm -rf feeds/luci/applications/luci-app-passwall
        rm -rf feeds/luci/applications/luci-app-smartdns
        rm -rf feeds/packages/lang/golang
        
        ./scripts/feeds install -a -f

    - name: 4. 固件定制配置
      run: |
        cd openwrt
        cat >> .config <<EOF
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_DEVICE_generic=y
        CONFIG_LUCI_LANG_zh_Hans=y
        CONFIG_PACKAGE_luci-theme-bootstrap=y
        CONFIG_LUCI_THEME_DEFAULT="bootstrap"
        CONFIG_PACKAGE_kmod-e1000=y
        CONFIG_PACKAGE_kmod-e1000e=y
        CONFIG_PACKAGE_kmod-usb-net=y
        CONFIG_PACKAGE_kmod-usb-net-asix=y
        CONFIG_PACKAGE_kmod-usb-net-rtl8152=y
        CONFIG_PACKAGE_luci-app-passwall=y
        CONFIG_PACKAGE_luci-app-smartdns=y
        CONFIG_PACKAGE_luci-app-adguardhome=y
        # CONFIG_PACKAGE_luci-app-adguardhome_INCLUDE_binary is not set
        CONFIG_PACKAGE_luci-app-ddns=y
        CONFIG_PACKAGE_ddns-scripts-cloudflare=y
        CONFIG_PACKAGE_luci-app-syncdial=y
        CONFIG_PACKAGE_luci-app-mwan3=y
        CONFIG_PACKAGE_ipv6helper=y
        EOF
        
        make defconfig

    - name: 5. 源码预下载
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: 6. 执行编译
      id: compile
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s 2>&1 | tee build.log
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=fail" >> $GITHUB_OUTPUT
        fi
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: 7. 整理固件与配置文件
      if: always()
      run: |
        mkdir -p FIRMWARE
        # 搜寻所有生成的镜像文件、配置文件和清单
        # 包含常见的 .img, .gz, .vmdk, .manifest 等
        find openwrt/bin/targets/x86/64/ -type f \
          \( -name "*.img*" -o -name "*.manifest" -o -name "*.config" -o -name "*.vmdk" -o -name "*.buildinfo" \) \
          -exec cp -v {} FIRMWARE/ \;
        
        # 检查是否真的搜寻到了文件
        if [ -z "$(ls -A FIRMWARE)" ]; then
          echo "警告：未找到编译生成的固件文件！"
        else
          echo "固件整理完成，准备上传。"
        fi

    - name: 8. 上传所有固件
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_x86_64_Firmware_${{ env.FILE_DATE }}
        path: FIRMWARE/

    - name: 9. 上传编译日志 (供报错排查)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Build_Log_Error_${{ env.FILE_DATE }}
        path: openwrt/build.log

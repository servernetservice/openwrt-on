name: OpenWrt_24.10_Full_Software_Upload

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: 1. 检出源码
      uses: actions/checkout@v4

    - name: 2. 安装环境与 Go 1.25 (官方二进制)
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://is.gd/depends_ubuntu_2204)
        sudo apt-get remove -y golang-go
        
        # 使用官方二进制包，确保满足 go >= 1.25 要求
        wget -q https://go.dev/dl/go1.25.0.linux-amd64.tar.gz
        sudo tar -C /usr/local -xzf go1.25.0.linux-amd64.tar.gz
        rm go1.25.0.linux-amd64.tar.gz
        
        echo "/usr/local/go/bin" >> $GITHUB_PATH
        sudo ln -sf /usr/local/go/bin/go /usr/bin/go
        sudo timedatectl set-timezone "$TZ"

    - name: 3. 更新插件源与去重
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default
        echo "src-git small https://github.com/kenzok8/small-package" >> feeds.conf.default
        
        ./scripts/feeds update -a
        rm -rf feeds/luci/applications/luci-app-passwall
        rm -rf feeds/luci/applications/luci-app-smartdns
        rm -rf feeds/packages/lang/golang
        ./scripts/feeds install -a -f

    - name: 4. 固件定制配置 (全量软件集成)
      run: |
        cd openwrt
        cat >> .config <<EOF
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_DEVICE_generic=y
        CONFIG_LUCI_LANG_zh_Hans=y
        CONFIG_PACKAGE_luci-theme-bootstrap=y
        CONFIG_LUCI_THEME_DEFAULT="bootstrap"
        
        # 核心插件驱动
        CONFIG_PACKAGE_kmod-e1000=y
        CONFIG_PACKAGE_kmod-e1000e=y
        CONFIG_PACKAGE_kmod-usb-net-rtl8152=y
        CONFIG_PACKAGE_luci-app-passwall=y
        CONFIG_PACKAGE_luci-app-smartdns=y
        CONFIG_PACKAGE_luci-app-adguardhome=y
        # CONFIG_PACKAGE_luci-app-adguardhome_INCLUDE_binary is not set
        CONFIG_PACKAGE_luci-app-ddns=y
        CONFIG_PACKAGE_ddns-scripts-cloudflare=y
        CONFIG_PACKAGE_luci-app-syncdial=y
        CONFIG_PACKAGE_luci-app-mwan3=y
        CONFIG_PACKAGE_ipv6helper=y
        CONFIG_PACKAGE_luci-app-ttyd=y
        EOF
        
        # 核心修正：强制将所有选择的软件内置到固件中
        sed -i 's/=m/=y/g' .config
        make defconfig

    - name: 5. 源码下载
      run: |
        cd openwrt
        make download -j8

    - name: 6. 执行编译
      id: compile
      run: |
        cd openwrt
        export PATH="/usr/local/go/bin:$PATH"
        # 优先多线程，失败转单线程捕获日志
        make -j$(nproc) || make -j1 V=s 2>&1 | tee build.log
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=fail" >> $GITHUB_OUTPUT
        fi
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: 7. 整理全量产出 (语法错误彻底修复)
      if: always()
      run: |
        # 建立收集目录
        mkdir -p FIRMWARE_ALL
        
        # 1. 递归拷贝 bin 目录下所有文件 (含固件和所有 ipk 软件包)
        if [ -d "openwrt/bin" ]; then
          cp -rf openwrt/bin/* FIRMWARE_ALL/
        fi
        
        # 2. 拷贝配置文件和日志 (使用 test 确保安全)
        test -f openwrt/.config && cp openwrt/.config FIRMWARE_ALL/build_config.config || true
        test -f openwrt/build.log && cp openwrt/build.log FIRMWARE_ALL/ || true
        
        #
